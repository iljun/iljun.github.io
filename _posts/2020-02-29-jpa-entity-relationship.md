---
layout: post
title: JPA RelationShip
---

JPA에서의 연관 관계는 ERD와의 연관 관계와 조금 다르다.

ERD의 연관관계는 Table의 Foreign key를 이용하여 양방향으로 데이터를 찾을 수 있다.

JPA도 마찬가지로 Table의 Foreign key를 이용하지만, 객체의 참조를 이용하여 Entity끼리의 관계를 가진다.

JPA를 이용해 관계를 가지려면 Annotation을 이용해 가능하다.

객체의 연관 관계는 엄밀히는 단방향이다. 

양방향의 연관 관계는 단방향 연관 관계가 2개인 것이다.

# 연관 관계 주인 (Owner)

ERD의 연관 관계는 언제나 양방향이지만, 객체의 연관 관계는 언제나 양방향이 아니다.

객체의 참조를 서로 다른 2개의 객체가 가지고 있는 것인데, 서로 다른 2개의 객체가 서로 Foregin Key를 가지고 있다면, 
둘의 차이가 발생한다.

서로 각자 관리하는 Foregin Key가 언제나 동일하다는 보장을 할 수가 없다.

그렇기 때문에 연관 관계의 주인이 필요하다.( Foregin Key를 관리할 대상 )

이 연관 관계의 주인을 설정하기 위해서 `@mappedBy` 을 이용한다.

연관 관계의 주인만이 Foregin Key를 저장, 수정, 삭제가 가능하다.

DB Table에서는 `N : 1`, `1: N` 관계에서는 항상 N 쪽이 외래 키를 가진다.
그렇기 때문에 `@ManyToOne`에서는 mappedBy 속성을 가질 수 없다.

`1 : N`, `N : 1` 의 연관관계의 주인은 언제나 N 쪽이다.

양방향으로 Mapping을 하더라도 연관관계의 주인은 언제나 N이어야 한다.

## 주의점 

양방향 관계를 설정할 때 무한 루프에 빠지지 않도록 조심해야 한다.

가장 쉽게 만나볼 수 있는 문제는 `ToString`이다.

서로 양방향으로 관계가 맺어져 있고, `ToString`을 호출한다면 양방향으로 매핑된 객체들끼리 무한히 호출하게되 무한 루프에 빠질 수 있다.

이때는 `toString` 재정의 할 때 참조 계를 제거하거나, Lombok을 사용 시 `@ToString(excelude=)`를 사용해 쉽게 해결할 수 있다.

